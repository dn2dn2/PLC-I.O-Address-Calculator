<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC Address Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-blue-600">PLC I/O Address Calculator</h1>
                <div class="flex gap-3">
                    <button onclick="clearAllData()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Xo√° t·∫•t c·∫£ d·ªØ li·ªáu</button>
                    <select id="plcBrand" class="px-4 py-2 border-2 rounded-lg">
                        <option value="siemens">Siemens</option>
                        <option value="allenBradley">Allen-Bradley</option>
                        <option value="mitsubishi">Mitsubishi</option>
                        <option value="omron">Omron</option>
                    </select>
                    <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Export CSV</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-600 text-white rounded-lg p-4">
                <div class="text-sm">Digital Input</div>
                <div class="text-3xl font-bold" id="totalDI">0</div>
            </div>
            <div class="bg-green-600 text-white rounded-lg p-4">
                <div class="text-sm">Digital Output</div>
                <div class="text-3xl font-bold" id="totalDO">0</div>
            </div>
            <div class="bg-purple-600 text-white rounded-lg p-4">
                <div class="text-sm">Analog Input</div>
                <div class="text-3xl font-bold" id="totalAI">0</div>
            </div>
            <div class="bg-orange-600 text-white rounded-lg p-4">
                <div class="text-sm">Analog Output</div>
                <div class="text-3xl font-bold" id="totalAO">0</div>
            </div>
        </div>
<!-- ==================== ANALOG SCALING CALCULATOR - PHI√äN B·∫¢N SI√äU G·ªåN ==================== -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-5 text-indigo-700 flex items-center gap-3">
                <span>üßÆ Analog Scaling Calculator</span>
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- C·ªôt tr√°i: Calculator -->
                <div class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block font-semibold mb-1 text-gray-700">Raw Min (v√≠ d·ª•: 4mA)</label>
                            <input type="number" id="rawMin" value="0" class="w-full px-4 py-2 border-2 rounded-lg focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block font-semibold mb-1 text-gray-700">Raw Max (v√≠ d·ª•: 20mA)</label>
                            <input type="number" id="rawMax" value="27648" class="w-full px-4 py-2 border-2 rounded-lg focus:border-indigo-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block font-semibold mb-1 text-gray-700">Gi√° tr·ªã th·ª±c Min (V√≠ d·ª•: 0 Bar)</label>
                            <input type="number" step="any" id="euMin" value="0" class="w-full px-4 py-2 border-2 rounded-lg focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block font-semibold mb-1 text-gray-700">Gi√° tr·ªã th·ª±c Max (V√≠ d·ª•: 10 Bar)</label>
                            <input type="number" step="any" id="euMax" value="100" class="w-full px-4 py-2 border-2 rounded-lg focus:border-indigo-500">
                        </div>
                    </div>

                    <div>
                        <label class="block font-semibold mb-1 text-gray-700">ƒê∆°n v·ªã</label>
                        <input type="text" id="calcUnit" value="¬∞C" class="w-full px-4 py-2 border-2 rounded-lg focus:border-indigo-500" placeholder="bar, %, m¬≥/h, rpm...">
                    </div>

                    <div class="grid grid-cols-2 gap-6 mt-7 border-t pt-6">
                        <div>
                            <label class="block font-semibold mb-2 text-blue-600 text-lg">Raw (V√≠ d·ª•: 20 mA) ‚Üí Gi√° tr·ªã th·ª±c (V√≠ d·ª•: 10 Bar)</label>
                            <input type="number" id="inputRaw" placeholder="13824" class="w-full px-4 py-2 border-2 border-blue-300 rounded-lg font-mono text-lg">
                            <div class="mt-3 text-right text-2xl font-bold text-blue-600" id="resultEU">-</div>
                        </div>
                        <div>
                            <label class="block font-semibold mb-2 text-green-600 text-lg">Gi√° tr·ªã th·ª±c (V√≠ d·ª•: 10 Bar)‚Üí Raw (V√≠ d·ª•: 20 mA)</label>
                            <input type="number" step="any" id="inputEU" placeholder="75.5" class="w-full px-4 py-2 border-2 border-green-300 rounded-lg font-mono text-lg">
                            <div class="mt-3 text-right text-2xl font-bold text-green-600" id="resultRaw">-</div>
                        </div>
                    </div>
                </div>

                <!-- C·ªôt ph·∫£i: Preset + B·∫£ng nhanh -->
                <div>
                    <h3 class="font-bold text-lg mb-3">Preset c·∫£m bi·∫øn ph·ªï bi·∫øn (1 click)</h3>
                    <div class="grid grid-cols-2 gap-3 mb-5">
                        <button onclick="setPreset(0,27648,0,10,'bar')" class="p-3 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg hover:shadow-md border text-left font-medium">0-10 bar</button>
                        <button onclick="setPreset(0,27648,0,16,'bar')" class="p-3 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg hover:shadow-md border text-left font-medium">0-16 bar</button>
                        <button onclick="setPreset(6241,31208,-50,200,'¬∞C')" class="p-3 bg-gradient-to-r from-red-50 to-red-100 rounded-lg hover:shadow-md border text-left font-medium">PT100 -50‚Üí200¬∞C</button>
                        <button onclick="setPreset(0,27648,0,100,'m¬≥/h')" class="p-3 bg-gradient-to-r from-cyan-50 to-cyan-100 rounded-lg hover:shadow-md border text-left font-medium">0-100 m¬≥/h</button>
                        <button onclick="setPreset(0,27648,0,5,'m H‚ÇÇO')" class="p-3 bg-gradient-to-r from-teal-50 to-teal-100 rounded-lg hover:shadow-md border text-left font-medium">M·ª©c n∆∞·ªõc 0-5m</button>
                        <button onclick="setPreset(6241,31208,0,500,'¬∞C')" class="p-3 bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg hover:shadow-md border text-left font-medium">Nhi·ªát ƒë·ªô cao 0-500¬∞C</button>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4 font-mono text-sm border">
                        <table class="w-full">
                            <thead><tr class="border-b"><th class="text-left py-2">%</th><th class="text-left py-2">Raw</th><th class="text-left py-2">Gi√° tr·ªã th·ª±c</th></tr></thead>
                            <tbody id="quickTable" class="text-gray-700">
                                <tr><td class="py-1">0%</td>   <td id="v0">-</td>   <td id="eu0">-</td></tr>
                                <tr><td class="py-1">25%</td>  <td id="v25">-</td>  <td id="eu25">-</td></tr>
                                <tr><td class="py-1">50%</td>  <td id="v50">-</td>  <td id="eu50">-</td></tr>
                                <tr><td class="py-1">75%</td>  <td id="v75">-</td>  <td id="eu75">-</td></tr>
                                <tr><td class="py-1">100%</td> <td id="v100">-</td> <td id="eu100">-</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>  <!-- ƒë√≥ng ph·∫ßn Analog Calculator -->
    </div>      <!-- <<< TH√äM D√íNG N√ÄY: ƒë√≥ng div max-w-7xl mx-auto c·ªßa ph·∫ßn tr√™n -->

    <!-- Ph·∫ßn PLC I/O ch√≠nh th·ª©c b·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë√¢y, t√°ch bi·ªát ho√†n to√†n -->
    <div class="max-w-7xl mx-auto mt-12">   <!-- <<< THAY D√íNG N√ÄY: m·ªü l·∫°i container m·ªõi + mt-12 ƒë·ªÉ c√≥ kho·∫£ng c√°ch ƒë·∫πp -->
        <div class="grid grid-cols-3 gap-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Th∆∞ vi·ªán thi·∫øt b·ªã</h2>
                    <button onclick="showAddModal()" class="bg-blue-600 text-white px-3 py-1 rounded">+ Th√™m m·ªõi</button>
                </div>
                <div id="templateList" class="space-y-3"></div>
            </div>

            <div class="col-span-2 space-y-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4">Danh s√°ch thi·∫øt b·ªã</h2>
                    <div id="deviceList"></div>
                </div>

                <div id="addressTable" class="bg-white rounded-xl shadow-lg p-6" style="display:none">
                    <h2 class="text-xl font-bold mb-4">B·∫£ng ƒë·ªãa ch·ªâ</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-3 py-2 text-left">Thi·∫øt b·ªã</th>
                                    <th class="px-3 py-2 text-left">Lo·∫°i</th>
                                    <th class="px-3 py-2 text-left">T√™n</th>
                                    <th class="px-3 py-2 text-left">ƒê·ªãa ch·ªâ</th>
                                </tr>
                            </thead>
                            <tbody id="addressBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-screen overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Ch·ªânh s·ª≠a thi·∫øt b·ªã</h2>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2 font-semibold">T√™n thi·∫øt b·ªã</label>
                    <input type="text" id="modalName" class="w-full px-3 py-2 border rounded">
                </div>
                <div>
                    <label class="block mb-2 font-semibold">Icon</label>
                    <input type="text" id="modalIcon" class="w-full px-3 py-2 border rounded">
                </div>
                <div id="modalIO"></div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal()" class="px-4 py-2 border rounded">Hu·ª∑</button>
                <button onclick="saveModal()" class="px-4 py-2 bg-blue-600 text-white rounded">L∆∞u</button>
            </div>
        </div>
    </div>

    <script>
        const defaultTemplates = [
            {
                id: 'dol',
                name: 'Kh·ªüi ƒë·ªông tr·ª±c ti·∫øp (DOL)',
                icon: '‚ö°',
                config: {
                    DI: [{name: 'AUTO STATUS', count: 1}, {name: 'RUN STATUS', count: 1}, {name: 'FAULT STATUS', count: 1}],
                    DO: [{name: 'CMD RUN', count: 1}],
                    AI: [],
                    AO: []
                }
            },
            {
                id: 'inv',
                name: 'Kh·ªüi ƒë·ªông qua bi·∫øn t·∫ßn (INV)',
                icon: 'üåü',
                config: {
                    DI: [{name: 'AUTO STATUS', count: 1}, {name: 'RUN STATUS', count: 1}, {name: 'FAULT STATUS', count: 1}],
                    DO: [{name: 'CMD RUN', count: 1}],
                    AI: [{name: 'ƒêi·ªÅu khi·ªÉn t·∫ßn s·ªë', count: 1}],
                    AO: [{name: 'Ph·∫£n h·ªìi t·∫ßn s·ªë', count: 1}]
                }
            },
            {
                id: 'valve',
                name: 'Van ƒëi·ªán t·ª´',
                icon: 'üö∞',
                config: {
                    DI: [{name: 'OPEN STATUS', count: 1}, {name: 'CLOSE STATUS', count: 1}],
                    DO: [{name: 'CMD OPEN', count: 1}],
                    AI: [],
                    AO: []
                }
            },
            {
                id: 'temp',
                name: 'C·∫£m bi·∫øn nhi·ªát ƒë·ªô',
                icon: 'üå°',
                config: {
                    DI: [],
                    DO: [],
                    AI: [{name: 'Temperature', count: 1}],
                    AO: []
                }
            }
        ];

        function loadData() {
            try {
                const savedTemplates = localStorage.getItem('plc_templates');
                const savedDevices = localStorage.getItem('plc_devices');
                const savedBrand = localStorage.getItem('plc_brand');
                
                return {
                    templates: savedTemplates ? JSON.parse(savedTemplates) : defaultTemplates,
                    devices: savedDevices ? JSON.parse(savedDevices) : [],
                    brand: savedBrand || 'siemens'
                };
            } catch (e) {
                return {
                    templates: defaultTemplates,
                    devices: [],
                    brand: 'siemens'
                };
            }
        }

        function saveData() {
            try {
                localStorage.setItem('plc_templates', JSON.stringify(templates));
                localStorage.setItem('plc_devices', JSON.stringify(devices));
                localStorage.setItem('plc_brand', document.getElementById('plcBrand').value);
            } catch (e) {
                console.error('Khong the luu du lieu:', e);
            }
        }

        const data = loadData();
        let templates = data.templates;
        let devices = data.devices;
        let editingTemplate = null;

        const formats = {
            siemens: {
                DI: (b, i) => `I${b}.${i}`,
                DO: (b, i) => `Q${b}.${i}`,
                AI: (w) => `IW${w * 2}`,
                AO: (w) => `QW${w * 2}`
            },
            allenBradley: {
                DI: (b, i) => `I:${b}/${i}`,
                DO: (b, i) => `O:${b}/${i}`,
                AI: (w) => `I:${w}`,
                AO: (w) => `O:${w}`
            },
            mitsubishi: {
                DI: (b, i) => `X${(b * 8 + i).toString(16).toUpperCase()}`,
                DO: (b, i) => `Y${(b * 8 + i).toString(16).toUpperCase()}`,
                AI: (w) => `D${w}`,
                AO: (w) => `D${w + 1000}`
            },
            omron: {
                DI: (b, i) => `${b}.${String(i).padStart(2, '0')}`,
                DO: (b, i) => `${100 + b}.${String(i).padStart(2, '0')}`,
                AI: (w) => `CIO${w}`,
                AO: (w) => `CIO${w + 100}`
            }
        };

        function renderTemplates() {
            const html = templates.map(t => {
                const di = t.config.DI.reduce((s, x) => s + x.count, 0);
                const do_ = t.config.DO.reduce((s, x) => s + x.count, 0);
                const ai = t.config.AI.reduce((s, x) => s + x.count, 0);
                const ao = t.config.AO.reduce((s, x) => s + x.count, 0);
                return `
                    <div class="border rounded-lg p-3">
                        <div class="flex gap-2 items-start">
                            <div class="text-2xl font-bold">${t.icon}</div>
                            <div class="flex-1">
                                <div class="font-semibold">${t.name}</div>
                                <div class="text-xs text-gray-600">${di ? 'DI:' + di : ''} ${do_ ? 'DO:' + do_ : ''} ${ai ? 'AI:' + ai : ''} ${ao ? 'AO:' + ao : ''}</div>
                                <div class="flex gap-2 mt-2">
                                    <input type="number" min="1" value="1" id="qty-${t.id}" class="w-16 px-2 py-1 border rounded text-sm">
                                    <button onclick="addDevice('${t.id}')" class="flex-1 bg-blue-600 text-white px-2 py-1 rounded text-sm">Th√™m</button>
                                    <button onclick="editTemplate('${t.id}')" class="bg-gray-300 px-2 py-1 rounded text-sm">S·ª≠a</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('templateList').innerHTML = html;
        }

        function renderDevices() {
            if (devices.length === 0) {
                document.getElementById('deviceList').innerHTML = '<div class="text-center text-gray-400 py-8">Ch∆∞a c√≥ thi·∫øt b·ªã</div>';
                document.getElementById('addressTable').style.display = 'none';
            } else {
                const html = devices.map((d, i) => {
                    const di = d.config.DI.reduce((s, x) => s + x.count, 0);
                    const do_ = d.config.DO.reduce((s, x) => s + x.count, 0);
                    const ai = d.config.AI.reduce((s, x) => s + x.count, 0);
                    const ao = d.config.AO.reduce((s, x) => s + x.count, 0);
                    return `
                        <div class="border rounded-lg p-3 mb-3">
                            <div class="flex justify-between items-center">
                                <div class="flex gap-2 items-center">
                                    <span class="text-xl font-bold">${d.icon}</span>
                                    <span class="font-semibold">${d.name}</span>
                                    <span class="text-xs text-gray-600">DI:${di} DO:${do_} AI:${ai} AO:${ao}</span>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <input type="number" min="1" value="${d.quantity}" onchange="updateQty(${i}, this.value)" class="w-16 px-2 py-1 border rounded">
                                    <button onclick="removeDevice(${i})" class="bg-red-500 text-white px-2 py-1 rounded">Xo√°</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('deviceList').innerHTML = html;
                document.getElementById('addressTable').style.display = 'block';
                renderAddresses();
            }
            updateTotals();
        }

        function renderAddresses() {
            const brand = document.getElementById('plcBrand').value;
            const fmt = formats[brand];
            let addr = {
                DI: {byte: 0, bit: 0},
                DO: {byte: 0, bit: 0},
                AI: {word: 0},
                AO: {word: 0}
            };
            
            const rows = [];
            devices.forEach(dev => {
                for (let n = 1; n <= dev.quantity; n++) {
                    ['DI', 'DO', 'AI', 'AO'].forEach(type => {
                        dev.config[type].forEach(sig => {
                            for (let i = 0; i < sig.count; i++) {
                                let address;
                                if (type === 'DI' || type === 'DO') {
                                    address = fmt[type](addr[type].byte, addr[type].bit);
                                    addr[type].bit++;
                                    if (addr[type].bit >= 8) {
                                        addr[type].bit = 0;
                                        addr[type].byte++;
                                    }
                                } else {
                                    address = fmt[type](addr[type].word);
                                    addr[type].word++;
                                }
                                rows.push(`
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-3 py-2">${dev.name} #${n}</td>
                                        <td class="px-3 py-2"><span class="px-2 py-1 rounded text-xs ${type === 'DI' ? 'bg-blue-100' : type === 'DO' ? 'bg-green-100' : type === 'AI' ? 'bg-purple-100' : 'bg-orange-100'}">${type}</span></td>
                                        <td class="px-3 py-2">${sig.name}</td>
                                        <td class="px-3 py-2"><code class="bg-gray-100 px-2 py-1 rounded">${address}</code></td>
                                    </tr>
                                `);
                            }
                        });
                    });
                }
            });
            document.getElementById('addressBody').innerHTML = rows.join('');
        }

        function addDevice(tid) {
            const t = templates.find(x => x.id === tid);
            const qty = parseInt(document.getElementById('qty-' + tid).value) || 1;
            devices.push({
                id: Date.now(),
                templateId: tid,
                name: t.name,
                icon: t.icon,
                quantity: qty,
                config: JSON.parse(JSON.stringify(t.config))
            });
            document.getElementById('qty-' + tid).value = '1';
            saveData();
            renderDevices();
        }

        function removeDevice(i) {
            devices.splice(i, 1);
            saveData();
            renderDevices();
        }

        function updateQty(i, v) {
            devices[i].quantity = parseInt(v) || 1;
            saveData();
            renderDevices();
        }

        function updateTotals() {
            const totals = {DI: 0, DO: 0, AI: 0, AO: 0};
            devices.forEach(d => {
                ['DI', 'DO', 'AI', 'AO'].forEach(type => {
                    totals[type] += d.config[type].reduce((s, x) => s + x.count, 0) * d.quantity;
                });
            });
            document.getElementById('totalDI').textContent = totals.DI;
            document.getElementById('totalDO').textContent = totals.DO;
            document.getElementById('totalAI').textContent = totals.AI;
            document.getElementById('totalAO').textContent = totals.AO;
        }

        function showAddModal() {
            editingTemplate = {
                id: 'custom-' + Date.now(),
                name: '',
                icon: 'C',
                config: {DI: [], DO: [], AI: [], AO: []}
            };
            openModal();
        }

        function editTemplate(tid) {
            editingTemplate = JSON.parse(JSON.stringify(templates.find(t => t.id === tid)));
            openModal();
        }

        function openModal() {
            document.getElementById('modalName').value = editingTemplate.name;
            document.getElementById('modalIcon').value = editingTemplate.icon;
            renderModalIO();
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            editingTemplate = null;
        }

        function renderModalIO() {
            const types = ['DI', 'DO', 'AI', 'AO'];
            const html = types.map(type => `
                <div class="border rounded p-3 mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold">${type}</span>
                        <button onclick="addSignal('${type}')" class="bg-blue-600 text-white px-2 py-1 rounded text-sm">+ Th√™m</button>
                    </div>
                    <div id="signals-${type}">
                        ${editingTemplate.config[type].map((s, i) => `
                            <div class="flex gap-2 mb-2">
                                <input type="text" value="${s.name}" onchange="updateSig('${type}',${i},'name',this.value)" class="flex-1 px-2 py-1 border rounded" placeholder="Ten">
                                <input type="number" min="1" value="${s.count}" onchange="updateSig('${type}',${i},'count',this.value)" class="w-16 px-2 py-1 border rounded">
                                <button onclick="removeSig('${type}',${i})" class="bg-red-500 text-white px-2 py-1 rounded">X</button>
                            </div>
                        `).join('') || '<div class="text-gray-400 text-sm">Ch∆∞a c√≥</div>'}
                    </div>
                </div>
            `).join('');
            document.getElementById('modalIO').innerHTML = html;
        }

        function addSignal(type) {
            editingTemplate.config[type].push({name: '', count: 1});
            renderModalIO();
        }

        function updateSig(type, i, field, val) {
            editingTemplate.config[type][i][field] = field === 'count' ? parseInt(val) || 1 : val;
        }

        function removeSig(type, i) {
            editingTemplate.config[type].splice(i, 1);
            renderModalIO();
        }

        function saveModal() {
            editingTemplate.name = document.getElementById('modalName').value;
            editingTemplate.icon = document.getElementById('modalIcon').value;
            if (!editingTemplate.name) {
                alert('Nhap ten!');
                return;
            }
            const idx = templates.findIndex(t => t.id === editingTemplate.id);
            if (idx >= 0) {
                templates[idx] = editingTemplate;
            } else {
                templates.push(editingTemplate);
            }
            saveData();
            closeModal();
            renderTemplates();
        }

        function exportCSV() {
            if (devices.length === 0) {
                alert('Ch∆∞a c√≥ thi·∫øt b·ªã!');
                return;
            }
            const brand = document.getElementById('plcBrand').value;
            const fmt = formats[brand];
            let addr = {
                DI: {byte: 0, bit: 0},
                DO: {byte: 0, bit: 0},
                AI: {word: 0},
                AO: {word: 0}
            };
            
            let csv = 'Thiet bi,Loai,Ten,Dia chi\n';
            devices.forEach(dev => {
                for (let n = 1; n <= dev.quantity; n++) {
                    ['DI', 'DO', 'AI', 'AO'].forEach(type => {
                        dev.config[type].forEach(sig => {
                            for (let i = 0; i < sig.count; i++) {
                                let address;
                                if (type === 'DI' || type === 'DO') {
                                    address = fmt[type](addr[type].byte, addr[type].bit);
                                    addr[type].bit++;
                                    if (addr[type].bit >= 8) {
                                        addr[type].bit = 0;
                                        addr[type].byte++;
                                    }
                                } else {
                                    address = fmt[type](addr[type].word);
                                    addr[type].word++;
                                }
                                csv += `"${dev.name} #${n}",${type},"${sig.name}",${address}\n`;
                            }
                        });
                    });
                }
            });
            
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `plc_${brand}_${Date.now()}.csv`;
            a.click();
        }

        function clearAllData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° t·∫•t c·∫£ d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                localStorage.removeItem('plc_templates');
                localStorage.removeItem('plc_devices');
                localStorage.removeItem('plc_brand');
                templates = JSON.parse(JSON.stringify(defaultTemplates));
                devices = [];
                document.getElementById('plcBrand').value = 'siemens';
                renderTemplates();
                renderDevices();
                alert('ƒê√£ xo√° t·∫•t c·∫£ d·ªØ li·ªáu!');
            }
        }

        document.getElementById('plcBrand').addEventListener('change', () => {
            saveData();
            if (devices.length > 0) renderAddresses();
        });

        document.getElementById('plcBrand').value = data.brand;
        renderTemplates();
        renderDevices();
        // ===================== ANALOG SCALING CALCULATOR - PHI√äN B·∫¢N G·ªåN NH·∫§T =====================
        function calculateAll() {
            const rawMin = parseFloat(document.getElementById('rawMin').value) || 0;
            const rawMax = parseFloat(document.getElementById('rawMax').value) || 27648;
            const euMin  = parseFloat(document.getElementById('euMin').value) || 0;
            const euMax  = parseFloat(document.getElementById('euMax').value) || 100;
            const unit   = document.getElementById('calcUnit').value || '';

            const inputRaw = parseFloat(document.getElementById('inputRaw').value);
            const inputEU  = parseFloat(document.getElementById('inputEU').value);

            // Raw ‚Üí EU
            if (!isNaN(inputRaw)) {
                let eu = euMin + (inputRaw - rawMin) * (euMax - euMin) / (rawMax - rawMin);
                eu = Math.max(euMin, Math.min(euMax, eu)); // clamp
                document.getElementById('resultEU').textContent = eu.toFixed(2) + ' ' + unit;
            } else {
                document.getElementById('resultEU').textContent = '-';
            }

            // EU ‚Üí Raw
			if (!isNaN(inputEU)) {
				let raw = rawMin + (inputEU - euMin) * (rawMax - rawMin) / (euMax - euMin);
				raw = Math.max(rawMin, Math.min(rawMax, raw)); // ch·ªâ clamp, kh√¥ng round
				document.getElementById('resultRaw').textContent = raw.toFixed(2); // hi·ªÉn th·ªã 3 ch·ªØ s·ªë th·∫≠p ph√¢n
			} else {
				document.getElementById('resultRaw').textContent = '-';
			}

            // B·∫£ng nhanh 0-25-50-75-100%
            const percent = [0,25,50,75,100];
            percent.forEach(p => {
                const raw = rawMin + (rawMax - rawMin) * p / 100;
                const eu  = euMin  + (euMax  - euMin)  * p / 100;
                document.getElementById('v'+p).textContent = Math.round(raw);
                document.getElementById('eu'+p).textContent = eu.toFixed(2) + ' ' + unit;
            });
        }

        function setPreset(minRaw, maxRaw, minEU, maxEU, unit) {
            document.getElementById('rawMin').value = minRaw;
            document.getElementById('rawMax').value = maxRaw;
            document.getElementById('euMin').value = minEU;
            document.getElementById('euMax').value = maxEU;
            document.getElementById('calcUnit').value = unit;
            calculateAll();
        }

        // Events
        ['rawMin','rawMax','euMin','euMax','calcUnit','inputRaw','inputEU'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', calculateAll);
        });

        // Kh·ªüi ƒë·ªông
        calculateAll();
    </script>
</body>
</html>


